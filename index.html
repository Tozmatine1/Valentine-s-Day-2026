<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Our Story Map üíò</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --bg1:#ffe3ec; --bg2:#fff;
      --card:rgba(255,255,255,.88);
      --border:rgba(0,0,0,.08);
      --shadow:0 12px 40px rgba(0,0,0,.10);
      --pink:#ff2d55;
      --text:#222;
      --muted:rgba(0,0,0,.65);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,var(--bg1),var(--bg2));
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 28px;display:grid;gap:14px}
    .top{
      background:var(--card);
      backdrop-filter:blur(10px);
      border:1px solid var(--border);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:16px;
    }
    .top h1{margin:0 0 6px;font-size:26px;letter-spacing:-.2px}
    .top p{margin:0;color:var(--muted);line-height:1.35}
    .grid{display:grid;grid-template-columns:1.6fr 1fr;gap:14px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    #map{
      height:540px;border-radius:22px;overflow:hidden;
      border:1px solid var(--border);box-shadow:var(--shadow);background:#fff;
    }
    .panel{
      background:var(--card);backdrop-filter:blur(10px);
      border:1px solid var(--border);border-radius:22px;box-shadow:var(--shadow);
      padding:16px;display:grid;gap:12px;min-height:540px;
    }
    .badge{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 12px;border-radius:999px;border:1px solid var(--border);
      width:fit-content;background:rgba(255,255,255,.65);font-weight:600;
    }
    .card{
      border:1px solid var(--border);
      border-radius:18px;padding:14px;background:rgba(255,255,255,.60);
    }
    .card h2{margin:0 0 6px;font-size:18px}
    .card p{margin:0;color:var(--muted);line-height:1.45}

    .buttons{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    button{
      border:0;border-radius:999px;padding:11px 16px;font-size:15px;
      cursor:pointer;transition:transform .08s ease;
    }
    button:active{transform:scale(.98)}
    .primary{background:var(--pink);color:#fff}
    .ghost{background:#eee}
    .small{font-size:12px;color:var(--muted);line-height:1.35}

    /* --- pretty markers (active pulses) --- */
    .tpin{
      width:34px;height:34px;border-radius:999px;display:grid;place-items:center;
      font-size:16px;border:2px solid rgba(0,0,0,.12);
      box-shadow:0 10px 22px rgba(0,0,0,.18);
      background:#fff;
    }
    .tpin.active{
      border-color:rgba(255,45,85,.65);
      box-shadow:0 0 0 6px rgba(255,45,85,.15),0 12px 30px rgba(255,45,85,.25);
      animation:pulse 1.25s ease-in-out infinite;
    }
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.10)}100%{transform:scale(1)}}

    /* hearts */
    .hearts{position:fixed;inset:0;pointer-events:none;overflow:hidden}
    .heart{position:absolute;bottom:-40px;font-size:22px;animation:floatUp linear forwards;opacity:.9}
    @keyframes floatUp{to{transform:translateY(-110vh) rotate(20deg);opacity:0}}

    /* final overlay */
    .overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.45);
      display:none;align-items:center;justify-content:center;padding:16px;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(560px,94vw);
      background:rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.7);
      border-radius:24px;
      box-shadow:0 30px 80px rgba(0,0,0,.25);
      padding:22px;text-align:center;
    }
    .modal h3{margin:0 0 8px;font-size:28px;letter-spacing:-.2px}
    .modal p{margin:0 0 14px;color:var(--muted)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <h1>üó∫Ô∏è Our Story Map</h1>
      <p>
        Sophia, I wanted us to revisit the places that quietly became everything.
        One memory at a time‚Ä¶ leading to today. üíó
      </p>
    </div>

    <div class="grid">
      <div id="map"></div>

      <div class="panel">
        <div class="badge" id="badge">Loading the map‚Ä¶</div>

        <div class="card">
          <h2 id="title">Getting things ready‚Ä¶</h2>
          <p id="body">Placing your memories on the map.</p>

          <div class="buttons" id="btns"></div>
        </div>

        <div class="small">
          Tip: you can click any pin, or use Next/Back like a timeline.
        </div>
      </div>
    </div>
  </div>

  <div class="hearts" id="hearts"></div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <h3>Sophia‚Ä¶ will you be my Valentine? üíò</h3>
      <p>Our first Valentine‚Äôs Day ‚Äî and a lot more chapters after this.</p>
      <div class="buttons" style="justify-content:center;">
        <button class="primary" id="yesBtn">Yes üíñ</button>
        <button class="ghost" id="noBtn">No üôÉ</button>
      </div>
      <div style="margin-top:10px;font-weight:700" id="finalMsg"></div>
    </div>
  </div>

<script>
  // -----------------------------
  // Your memories (in order)
  // -----------------------------
  const stops = [
    { label: "Zaytinya", query: "Zaytinya, New York City, NY", memory: "Our first date" },
    { label: "Central Park", query: "Central Park, New York City, NY", memory: "Our first kiss" },
    { label: "Tarrytown", query: "Tarrytown, NY", memory: "I asked you to be my girlfriend" },
    { label: "Hadestown (Broadway)", query: "Broadway Theatre, New York City, NY", memory: "We went to Hades" },
    { label: "Bad Roman", query: "Bad Roman, New York City, NY", memory: "You came back to me" },
    { label: "Madison Square Garden", query: "Madison Square Garden, New York City, NY", memory: "You gave me the best birthday ever" },
    { label: "Gaia Restaurant", query: "Gaia Restaurant, New York City, NY", memory: "Our first Valentine's day." }
  ];

  // -----------------------------
  // UI refs
  // -----------------------------
  const badge = document.getElementById("badge");
  const titleEl = document.getElementById("title");
  const bodyEl  = document.getElementById("body");
  const btns    = document.getElementById("btns");
  const overlay = document.getElementById("overlay");
  const finalMsg= document.getElementById("finalMsg");
  const hearts  = document.getElementById("hearts");

  // -----------------------------
  // Map setup
  // -----------------------------
  const map = L.map("map", { zoomControl: true });

  // Choose your tiles (keep whichever you liked)
  L.tileLayer("https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png", {
  maxZoom: 20,
  attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
}).addTo(map);

  map.setView([40.75, -73.98], 12);

  // route line (we‚Äôll only draw up to current stop)
  const routeLine = L.polyline([], { weight: 5, opacity: 0.9, dashArray: "8 10" }).addTo(map);

  // We'll only show ONE marker at a time
  const markerLayer = L.layerGroup().addTo(map);

  const coords = new Array(stops.length).fill(null);
  let currentIndex = 0;

  function makeIcon() {
    return L.divIcon({
      className: "",
      html: `<div class="tpin active">üíó</div>`,
      iconSize: [34, 34],
      iconAnchor: [17, 17]
    });
  }

  function popHearts(count = 25){
    for (let i = 0; i < count; i++){
      const s = document.createElement("div");
      s.className = "heart";
      s.textContent = ["üíó","üíñ","üíò","üíù","üíï"][Math.floor(Math.random()*5)];
      s.style.left = (Math.random()*100) + "vw";
      s.style.animationDuration = (2 + Math.random()*2.5) + "s";
      s.style.fontSize = (18 + Math.random()*22) + "px";
      s.style.opacity = (0.5 + Math.random()*0.5);
      hearts.appendChild(s);
      setTimeout(() => s.remove(), 5000);
    }
  }

  function render(i){
    currentIndex = i;

    badge.textContent = `Memory ${i + 1} of ${stops.length}`;
    titleEl.textContent = stops[i].label;
    bodyEl.textContent = stops[i].memory;

    // Buttons
    btns.innerHTML = "";

    const back = document.createElement("button");
    back.className = "ghost";
    back.textContent = "‚Üê Back";
    back.disabled = (i === 0);
    if (back.disabled) back.style.opacity = 0.5;
    back.onclick = () => render(i - 1);

    const next = document.createElement("button");
    next.className = "primary";
    next.textContent = (i === stops.length - 1) ? "One more thing‚Ä¶ üíò" : "Next ‚Üí";
    next.onclick = () => {
      if (i === stops.length - 1) {
        overlay.classList.add("show");
        popHearts(45);
      } else {
        render(i + 1);
      }
    };

    btns.appendChild(back);
    btns.appendChild(next);

    // Show ONLY the current marker
    markerLayer.clearLayers();

    const c = coords[i];
    if (c) {
      const m = L.marker(c, { icon: makeIcon() }).addTo(markerLayer);
      m.bindPopup(`<b>${stops[i].label}</b><br><i>${stops[i].memory}</i>`).openPopup();

      // Pan/zoom nicely so the location feels ‚Äúfeatured‚Äù
      map.flyTo(c, 14, { animate: true, duration: 0.9 });
    }

    // Draw route only up to current memory (romantic ‚Äúpath so far‚Äù)
    const linePts = coords.slice(0, i + 1).filter(Boolean);
    routeLine.setLatLngs(linePts);
  }

  // -----------------------------
  // Geocoding (cached)
  // -----------------------------
  async function geocodePlace(placeText){
    const cacheKey = "geo_" + placeText.toLowerCase();
    const cached = localStorage.getItem(cacheKey);
    if (cached) { try { return JSON.parse(cached); } catch {} }

    const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(placeText)}`;
    const res = await fetch(url, { headers: { "Accept": "application/json" } });
    const data = await res.json();
    if (!data || !data[0]) return null;

    const lat = parseFloat(data[0].lat);
    const lon = parseFloat(data[0].lon);
    if (!Number.isFinite(lat) || !Number.isFinite(lon)) return null;

    const out = [lat, lon];
    localStorage.setItem(cacheKey, JSON.stringify(out));
    return out;
  }

  async function init(){
    badge.textContent = "Placing memories‚Ä¶";
    titleEl.textContent = "Loading‚Ä¶";
    bodyEl.textContent = "One moment while we place your locations.";
    btns.innerHTML = "";

    // Geocode sequentially (reliable + polite)
    for (let i = 0; i < stops.length; i++){
      badge.textContent = `Finding: ${stops[i].label}‚Ä¶ (${i + 1}/${stops.length})`;
      const c = await geocodePlace(stops[i].query);
      coords[i] = c || [40.75 + i*0.01, -73.98 - i*0.01]; // fallback still works
      await new Promise(r => setTimeout(r, 650));
    }

    // Start at the first memory ONLY (others not shown)
    render(0);
  }

  // Final overlay buttons
  document.getElementById("yesBtn").addEventListener("click", () => {
    finalMsg.textContent = "YAY!!! üíû Screenshot this as proof üòå";
    popHearts(55);
    const no = document.getElementById("noBtn");
    no.disabled = true;
    no.style.opacity = 0.5;
  });

  document.getElementById("noBtn").addEventListener("mouseover", (e) => {
    const btn = e.currentTarget;
    const x = (Math.random() * 220) - 110;
    const y = (Math.random() * 120) - 60;
    btn.style.transform = `translate(${x}px, ${y}px)`;
  });

  overlay.addEventListener("click", (e) => {
    if (e.target === overlay) overlay.classList.remove("show");
  });

  init();
</script>

