<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Our Story Map üíò</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --pink:#ff2f55;
      --border:rgba(255,255,255,.10);
      --shadow:0 12px 40px rgba(0,0,0,.25);
      --muted:rgba(0,0,0,.60);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: rgb(255, 220, 235);
    }

    /* Keep your "not full width" feel */
    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:18px 14px 28px;
      display:grid;
      gap:12px;
    }

    /* Map stays the same size (width constrained by .wrap) */
    #map{
      height:540px;
      border-radius:22px;
      overflow:hidden;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      background:#fff;
    }

    /* Final question background card */
.final-question{
  background: rgb(255, 220, 235); /* same as body */
  padding: 16px 18px;
  border-radius: 18px;
  margin-bottom: 14px;
  box-shadow: 0 8px 20px rgba(0,0,0,.15);
}

.final-question h3{
  margin: 0 0 6px;
}

.final-question p{
  margin: 0;
}

    /* Floating hearts above map */
.hearts{
  position: fixed;
  inset: 0;
  pointer-events: none;
  overflow: hidden;

  z-index: 90000; /* above Leaflet, below modal */
}


    /* Buttons BELOW the map */
    .nav-controls{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
    }

    button{
      border:0;
      border-radius:999px;
      padding:11px 16px;
      font-size:15px;
      cursor:pointer;
      transition:transform .08s ease, opacity .15s ease;
      box-shadow:0 10px 22px rgba(0,0,0,.16);
    }
    button:active{transform:scale(.98)}
    button:disabled{cursor:not-allowed; opacity:.5}

    .primary{background:var(--pink);color:#fff}
    .ghost{background:#eee;color:#111}

    .hint{
      text-align:center;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
      margin-top:4px;
    }

    /* Pretty pin */
    .tpin{
      width:34px;height:34px;border-radius:999px;display:grid;place-items:center;
      font-size:16px;border:2px solid rgba(0,0,0,.12);
      box-shadow:0 10px 22px rgba(0,0,0,.18);
      background:#fff;
    }
    .tpin.active{
      border-color:rgba(255,45,85,.65);
      box-shadow:0 0 0 6px rgba(255,45,85,.15),0 12px 30px rgba(255,45,85,.25);
      animation:pulse 1.25s ease-in-out infinite;
    }
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.10)}100%{transform:scale(1)}}

    /* Hearts */
    .hearts{position:fixed;inset:0;pointer-events:none;overflow:hidden}
    .heart{position:absolute;bottom:-40px;font-size:22px;animation:floatUp linear forwards;opacity:.9}
    @keyframes floatUp{to{transform:translateY(-110vh) rotate(20deg);opacity:0}}

    /* Final overlay */
    /* Make sure the overlay is ALWAYS above the map */
.overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.45);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 16px;

  z-index: 99999; /* <-- key fix */
}

.overlay.show{ display:flex; }

/* Optional: ensure the modal itself is also above everything */
.modal{
  position: relative;
  z-index: 100000;
}
    .modal h3{margin:0 0 8px;font-size:28px;letter-spacing:-.2px}
    .modal p{margin:0 0 14px;color:rgba(0,0,0,.65)}
    .buttons{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:10px}

    @media (max-width:520px){
      .nav-controls{flex-direction:column;}
      .nav-controls button{width:100%;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div id="map"></div>

    <div class="nav-controls">
      <button id="prevBtn" class="ghost">‚Üê Back</button>
      <button id="nextBtn" class="primary">Next ‚Üí</button>
    </div>

    <div class="hint">Tip: click a pin to jump, or use Next/Back like a timeline.</div>
  </div>

  <div class="hearts" id="hearts"></div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="final-question">
        <h3 id="finalTitle">Sophia‚Ä¶ will you be my Valentine? üíò</h3>
         <p id="finalSubtitle">Our first Valentine‚Äôs Day ‚Äî and a lot more chapters after this.</p>
      </div>

      <div class="buttons">
        <button class="primary" id="yesBtn">Yes üíñ</button>
        <button class="ghost" id="noBtn">No üôÉ</button>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // Memories (personalized)
    // -----------------------------
    const stops = [
      { label: "Zaytinya", query: "Zaytinya, New York City, NY", memory: "We met for the first time at Zaytinya" },
      { label: "Central Park", query: "Central Park, New York City, NY", memory: "We had our first kiss at a picnic in Central Park" },
      { label: "Tarrytown", query: "Tarrytown, NY", memory: "I asked you to be my girlfriend at Tarrytown and you said yes :D" },
      { label: "Hadestown (Broadway)", query: "Broadway Theatre, New York City, NY", memory: "We went to broadway to see Hadestown before you went back to Texas" },
      { label: "Bad Roman", query: "Bad Roman, New York City, NY", memory: "You came back to me and I took you to Bad Roman" },
      { label: "Madison Square Garden", query: "Madison Square Garden, New York City, NY", memory: "You gave me the best birthday ever at MSG" },
      { label: "Gaia Restaurant", query: "Gaia Restaurant, New York City, NY", memory: "Our first Valentine's day" }
    ];

    // -----------------------------
    // Refs
    // -----------------------------
    const prevBtn  = document.getElementById("prevBtn");
    const nextBtn  = document.getElementById("nextBtn");
    const overlay  = document.getElementById("overlay");
    const finalMsg = document.getElementById("finalMsg");
    const hearts   = document.getElementById("hearts");

    // -----------------------------
    // Map setup
    // -----------------------------
    const map = L.map("map", { zoomControl: true });

    L.tileLayer("https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png", {
      maxZoom: 20,
      attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
    }).addTo(map);

    map.setView([40.75, -73.98], 12);

    // Store coordinates + markers
    const coords  = new Array(stops.length).fill(null);
    const markers = new Array(stops.length).fill(null);
    let currentIndex = 0;

    function iconHtml(isActive){
      return `<div class="tpin ${isActive ? "active" : ""}">üíó</div>`;
    }

    function makeIcon(isActive){
      return L.divIcon({
        className: "",
        html: iconHtml(isActive),
        iconSize: [34, 34],
        iconAnchor: [17, 17]
      });
    }

    function popHearts(count = 25){
      for (let i = 0; i < count; i++){
        const s = document.createElement("div");
        s.className = "heart";
        s.textContent = ["üíó","üíñ","üíò","üíù","üíï"][Math.floor(Math.random()*5)];
        s.style.left = (Math.random()*100) + "vw";
        s.style.animationDuration = (2 + Math.random()*2.5) + "s";
        s.style.fontSize = (18 + Math.random()*22) + "px";
        s.style.opacity = (0.5 + Math.random()*0.5);
        hearts.appendChild(s);
        setTimeout(() => s.remove(), 5000);
      }
    }

    function updateButtons(){
      prevBtn.disabled = (currentIndex === 0);
      nextBtn.textContent = (currentIndex === stops.length - 1) ? "but first..." : "Next ‚Üí";
    }

    function setActiveMarker(index){
      // Update icons so only the active pin pulses
      for (let i = 0; i < markers.length; i++){
        if (!markers[i]) continue;
        markers[i].setIcon(makeIcon(i === index));
      }
    }

    function goTo(index, { openPopup = true } = {}){
      currentIndex = index;
      updateButtons();
      setActiveMarker(index);

      const c = coords[index];
      if (!c) return;

      map.flyTo(c, 14, { animate: true, duration: 0.9 });

      const m = markers[index];
      if (m && openPopup) m.openPopup();
    }

    // -----------------------------
    // Geocoding (cached + throttled)
    // -----------------------------
    async function geocodePlace(placeText){
      const cacheKey = "geo_" + placeText.toLowerCase();
      const cached = localStorage.getItem(cacheKey);
      if (cached) { try { return JSON.parse(cached); } catch {} }

      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(placeText)}`;
      const res = await fetch(url, { headers: { "Accept": "application/json" } });
      const data = await res.json();
      if (!data || !data[0]) return null;

      const lat = parseFloat(data[0].lat);
      const lon = parseFloat(data[0].lon);
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) return null;

      const out = [lat, lon];
      localStorage.setItem(cacheKey, JSON.stringify(out));
      return out;
    }

    // -----------------------------
    // Init: geocode, create pins, wire navigation
    // -----------------------------
    async function init(){
      updateButtons();

      // Geocode sequentially (polite/reliable)
      for (let i = 0; i < stops.length; i++){
        const c = await geocodePlace(stops[i].query);
        coords[i] = c || [40.75 + i*0.01, -73.98 - i*0.01];
        await new Promise(r => setTimeout(r, 650));
      }

      // Create markers for all stops
      for (let i = 0; i < stops.length; i++){
        const m = L.marker(coords[i], { icon: makeIcon(i === 0) }).addTo(map);
        m.bindPopup(`<b>${stops[i].label}</b><br><i>${stops[i].memory}</i>`);
        m.on("click", () => goTo(i, { openPopup: true }));
        markers[i] = m;
      }

      // Start on first stop
      goTo(0, { openPopup: true });
    }

    // Buttons
    prevBtn.addEventListener("click", () => {
      if (currentIndex > 0) goTo(currentIndex - 1);
    });

    nextBtn.addEventListener("click", () => {
  if (currentIndex === stops.length - 1) {
    overlay.classList.add("show");
  } else {
    goTo(currentIndex + 1);
  }
});


document.getElementById("yesBtn").addEventListener("click", () => {
      finalMsg.textContent = "YAY!!! üíû Screenshot this as proof üòå";
      popHearts(55);
      const no = document.getElementById("noBtn");
      no.disabled = true;
      no.style.opacity = 0.5;
    });

    });

    document.getElementById("noBtn").addEventListener("mouseover", (e) => {
      const btn = e.currentTarget;
      const x = (Math.random() * 220) - 110;
      const y = (Math.random() * 120) - 60;
      btn.style.transform = `translate(${x}px, ${y}px)`;
    });

    overlay.addEventListener("click", (e) => {
      if (e.target === overlay) overlay.classList.remove("show");
    });

    init();
  </script>
</body>
</html>









