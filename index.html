<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sophia‚Äôs Treasure Map üíò</title>

  <!-- Leaflet (map library) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root {
      --bg1: #ffe3ec;
      --bg2: #fff;
      --card: rgba(255,255,255,0.86);
      --border: rgba(0,0,0,0.08);
      --shadow: 0 12px 40px rgba(0,0,0,0.10);
      --pink: #ff2d55;
      --text: #222;
      --muted: rgba(0,0,0,0.65);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(circle at top, var(--bg1), var(--bg2));
      color: var(--text);
    }

    .wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 14px 28px;
      display: grid;
      gap: 14px;
    }

    .top {
      background: var(--card);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .top h1 {
      margin: 0 0 6px;
      font-size: 26px;
      letter-spacing: -0.2px;
    }

    .top p {
      margin: 0;
      color: var(--muted);
      line-height: 1.35;
    }

    .grid {
      display: grid;
      grid-template-columns: 1.6fr 1fr;
      gap: 14px;
    }

    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
    }

    #map {
      height: 540px;
      border-radius: 22px;
      overflow: hidden;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      background: #fff;
    }

    .panel {
      background: var(--card);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 16px;
      display: grid;
      gap: 12px;
      min-height: 540px;
    }

    .badge {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      width: fit-content;
      background: rgba(255,255,255,0.65);
      font-weight: 600;
    }

    .card {
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 14px;
      background: rgba(255,255,255,0.60);
    }

    .card h2 {
      margin: 0 0 6px;
      font-size: 18px;
    }
    .card p {
      margin: 0;
      color: var(--muted);
      line-height: 1.35;
    }

    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    button {
      border: 0;
      border-radius: 999px;
      padding: 11px 16px;
      font-size: 15px;
      cursor: pointer;
      transition: transform .08s ease;
    }
    button:active { transform: scale(0.98); }
    .primary { background: var(--pink); color: white; }
    .ghost { background: #eee; }
    .disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .small {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .hearts {
      position: fixed;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
    }
    .heart {
      position: absolute;
      bottom: -40px;
      font-size: 22px;
      animation: floatUp linear forwards;
      opacity: 0.9;
    }
    @keyframes floatUp {
      to { transform: translateY(-110vh) rotate(20deg); opacity: 0; }
    }
/* --- Treasure marker styles --- */

.tpin {
  width: 34px;
  height: 34px;
  border-radius: 999px;
  display: grid;
  place-items: center;
  font-size: 16px;
  border: 2px solid rgba(0,0,0,0.12);
  box-shadow: 0 10px 22px rgba(0,0,0,0.18);
  background: white;
}

.tpin.locked {
  opacity: 0.55;
  filter: grayscale(1);
  box-shadow: none;
}

.tpin.found {
  opacity: 0.75;
}

.tpin.next {
  border-color: rgba(255,45,85,0.65);
  box-shadow: 0 0 0 6px rgba(255,45,85,0.15), 0 12px 30px rgba(255,45,85,0.25);
  animation: pulse 1.25s ease-in-out infinite;
}

@keyframes pulse {
  0%   { transform: scale(1); }
  50%  { transform: scale(1.10); }
  100% { transform: scale(1); }
}

    /* Final reveal overlay */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .overlay.show { display: flex; }
    .modal {
      width: min(560px, 94vw);
      background: rgba(255,255,255,0.92);
      border: 1px solid rgba(255,255,255,0.7);
      border-radius: 24px;
      box-shadow: 0 30px 80px rgba(0,0,0,0.25);
      padding: 22px;
      text-align: center;
    }
    .modal h3 {
      margin: 0 0 8px;
      font-size: 28px;
      letter-spacing: -0.2px;
    }
    .modal p {
      margin: 0 0 14px;
      color: var(--muted);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <h1>üó∫Ô∏è Sophia‚Äôs Treasure Map</h1>
      <p>
        Follow the route. Each pin is locked until the last clue is found.
        The final location holds the treasure. üíò
      </p>
    </div>

    <div class="grid">
      <div id="map"></div>

      <div class="panel">
        <div class="badge" id="progressBadge">Loading map‚Ä¶</div>

        <div class="card" id="card">
          <h2 id="cardTitle">Getting things ready‚Ä¶</h2>
          <p id="cardBody">This will take a few seconds the first time.</p>
          <div class="buttons" id="cardButtons"></div>
        </div>

        <div class="small" id="smallNote">
          Tip: If a place is slightly off, it‚Äôs okay ‚Äî it‚Äôs part of the ‚Äúmap‚Äù vibe.
        </div>
      </div>
    </div>
  </div>

  <div class="hearts" id="hearts"></div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <h3 id="finalTitle">Sophia‚Ä¶ will you be my Valentine? üíò</h3>
      <p id="finalSubtitle">Our first Valentine‚Äôs day ‚Äî and many more to come.</p>
      <div class="buttons" style="justify-content:center;">
        <button class="primary" id="yesBtn">Yes üíñ</button>
        <button class="ghost" id="noBtn">No üôÉ</button>
      </div>
      <div style="margin-top:10px; font-weight:700;" id="finalMsg"></div>
    </div>
  </div>

<script>
  // -----------------------------
  // 1) Your Treasure Map Stops
  // -----------------------------
  const stops = [
    { label: "Zaytinya", query: "Zaytinya, New York City, NY", clue: "Our first date" },
    { label: "Central Park", query: "Central Park, New York City, NY", clue: "Our first kiss" },
    { label: "Tarrytown", query: "Tarrytown, NY", clue: "I asked you to be my girlfriend" },
    { label: "Hadestown (Broadway)", query: "Broadway Theatre district, New York City, NY", clue: "We went to Hades" },
    { label: "Bad Roman", query: "Bad Roman, New York City, NY", clue: "You came back to me" },
    { label: "Madison Square Garden", query: "Madison Square Garden, New York City, NY", clue: "You gave me the best birthday ever" },
    { label: "Gaia Restaurant (Treasure)", query: "Gaia Restaurant, New York City, NY", clue: "Our first Valentine's day." }
  ];

  // -----------------------------
  // 2) Simple ‚Äúgame state‚Äù
  // -----------------------------
  const STORAGE_KEY = "valentine_treasure_progress_v1";
  function getProgress() {
    const raw = localStorage.getItem(STORAGE_KEY);
    const n = raw ? parseInt(raw, 10) : 0;
    return Number.isFinite(n) ? Math.max(0, Math.min(n, stops.length - 1)) : 0;
  }
  function setProgress(n) {
    localStorage.setItem(STORAGE_KEY, String(n));
  }

  let currentIndex = getProgress(); // which stop is unlocked right now
  let coords = new Array(stops.length).fill(null);

  // UI refs
  const progressBadge = document.getElementById("progressBadge");
  const cardTitle = document.getElementById("cardTitle");
  const cardBody = document.getElementById("cardBody");
  const cardButtons = document.getElementById("cardButtons");

  const overlay = document.getElementById("overlay");
  const finalMsg = document.getElementById("finalMsg");
  const hearts = document.getElementById("hearts");

  // -----------------------------
  // 3) Map setup (Leaflet + OSM)
  // -----------------------------
  const map = L.map("map", { zoomControl: true });
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // default to NYC if geocode takes a moment
  map.setView([40.75, -73.98], 12);

  const routeLine = L.polyline([], { weight: 5, opacity: 0.85, dashArray: "8 10" }).addTo(map);

  // markers
  const markers = [];

  function renderPanelDefault() {
    progressBadge.textContent = `Progress: ${Math.min(currentIndex + 1, stops.length)} / ${stops.length}`;
    cardTitle.textContent = "Your next clue is waiting‚Ä¶";
    cardBody.textContent = `Tap the highlighted pin: Stop ${currentIndex + 1} ‚Äî ${stops[currentIndex].label}`;
    cardButtons.innerHTML = "";

    const resetBtn = document.createElement("button");
    resetBtn.className = "ghost";
    resetBtn.textContent = "Reset Quest";
    resetBtn.onclick = () => {
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    };
    cardButtons.appendChild(resetBtn);
  }

  function popHearts(count = 25) {
    for (let i = 0; i < count; i++) {
      const s = document.createElement("div");
      s.className = "heart";
      s.textContent = ["üíó","üíñ","üíò","üíù","üíï"][Math.floor(Math.random()*5)];
      s.style.left = Math.random() * 100 + "vw";
      s.style.animationDuration = (2 + Math.random() * 2.5) + "s";
      s.style.fontSize = (18 + Math.random() * 22) + "px";
      s.style.opacity = (0.5 + Math.random() * 0.5);
      hearts.appendChild(s);
      setTimeout(() => s.remove(), 5000);
    }
  }

  function showStop(i) {
    const isUnlocked = i <= currentIndex;
    const isCurrent = i === currentIndex;

    progressBadge.textContent = `Progress: ${Math.min(currentIndex + 1, stops.length)} / ${stops.length}`;

    cardTitle.textContent = isCurrent
      ? `Stop ${i + 1}: ${stops[i].label} üß≠`
      : `Stop ${i + 1}: ${stops[i].label}`;

    cardBody.textContent = isUnlocked
      ? `Clue: ${stops[i].clue}`
      : "Locked. Follow the route in order üòâ";

    cardButtons.innerHTML = "";

    if (isCurrent) {
      const nextBtn = document.createElement("button");
      nextBtn.className = "primary";
      nextBtn.textContent = (i === stops.length - 1) ? "Open the Treasure üíò" : "Next Stop ‚Üí";
      nextBtn.onclick = () => {
        if (i === stops.length - 1) {
          // final reveal
          overlay.classList.add("show");
          popHearts(45);
          return;
        }
        currentIndex = Math.min(currentIndex + 1, stops.length - 1);
        setProgress(currentIndex);
        updateMarkerStyles();
        renderPanelDefault();
        // gently pan to next marker if available
        const nextCoord = coords[currentIndex];
        if (nextCoord) map.panTo(nextCoord, { animate: true, duration: 0.6 });
      };
      cardButtons.appendChild(nextBtn);
    } else {
      const closeHint = document.createElement("button");
      closeHint.className = "ghost";
      closeHint.textContent = "Okay";
      closeHint.onclick = renderPanelDefault;
      cardButtons.appendChild(closeHint);
    }
  }

  function updateMarkerStyles() {
    markers.forEach((m, i) => {
      // Use different emoji labels by swapping marker popup text
      const status =
        i < currentIndex ? "‚úÖ Found" :
        i === currentIndex ? "‚≠ê Next" :
        "üîí Locked";

      m.setPopupContent(`<b>Stop ${i + 1}: ${stops[i].label}</b><br>${status}<br><i>${stops[i].clue}</i>`);
      // no real color change without custom icons; popup + panel shows status clearly
    });
    // update route line
    const linePts = coords.filter(Boolean);
    routeLine.setLatLngs(linePts);
    if (linePts.length >= 2) {
      const bounds = L.latLngBounds(linePts);
      map.fitBounds(bounds.pad(0.25));
    }
  }

  // -----------------------------
  // 4) Geocoding (turn place text -> coordinates)
  // Uses OpenStreetMap Nominatim
  // -----------------------------
  async function geocodePlace(placeText) {
    const cacheKey = "geo_" + placeText.toLowerCase();
    const cached = localStorage.getItem(cacheKey);
    if (cached) {
      try { return JSON.parse(cached); } catch {}
    }

    const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(placeText)}`;
    const res = await fetch(url, {
      headers: {
        // Nominatim likes a descriptive header; browsers may not allow custom UA, so we use Referer-origin only.
        "Accept": "application/json"
      }
    });
    const data = await res.json();
    if (!data || !data[0]) return null;

    const lat = parseFloat(data[0].lat);
    const lon = parseFloat(data[0].lon);
    if (!Number.isFinite(lat) || !Number.isFinite(lon)) return null;

    const out = [lat, lon];
    localStorage.setItem(cacheKey, JSON.stringify(out));
    return out;
  }

  async function init() {
    progressBadge.textContent = "Loading locations‚Ä¶";
    cardTitle.textContent = "Charting the route‚Ä¶";
    cardBody.textContent = "One moment while we place your pins on the map.";
    cardButtons.innerHTML = "";

    // Create markers first (so UI feels instant)
    for (let i = 0; i < stops.length; i++) {
      const m = L.marker([40.75, -73.98]).addTo(map);
      m.bindPopup(`<b>Stop ${i + 1}: ${stops[i].label}</b><br>Loading‚Ä¶`);
      m.on("click", () => showStop(i));
      markers.push(m);
    }

    // Geocode sequentially (gentle on free service)
    for (let i = 0; i < stops.length; i++) {
      progressBadge.textContent = `Finding: ${stops[i].label}‚Ä¶ (${i + 1}/${stops.length})`;
      const c = await geocodePlace(stops[i].query);
      coords[i] = c;

      if (c) {
        markers[i].setLatLng(c);
      } else {
        // fallback: keep in NYC center, still playable
        markers[i].setLatLng([40.75 + i * 0.01, -73.98 - i * 0.01]);
      }

      // small delay to be polite
      await new Promise(r => setTimeout(r, 650));
    }

    updateMarkerStyles();
    renderPanelDefault();
  }

  // -----------------------------
  // 5) Final overlay buttons
  // -----------------------------
  document.getElementById("yesBtn").addEventListener("click", () => {
    finalMsg.textContent = "YAY!!! üíû Screenshot this as proof üòå";
    popHearts(55);
    document.getElementById("noBtn").classList.add("disabled");
    document.getElementById("noBtn").disabled = true;
  });

  document.getElementById("noBtn").addEventListener("mouseover", (e) => {
    // playful "no button runs away"
    const btn = e.currentTarget;
    const x = (Math.random() * 220) - 110;
    const y = (Math.random() * 120) - 60;
    btn.style.transform = `translate(${x}px, ${y}px)`;
  });

  // click outside modal to close (optional)
  overlay.addEventListener("click", (e) => {
    if (e.target === overlay) overlay.classList.remove("show");
  });

  init();
</script>
</body>
</html>
